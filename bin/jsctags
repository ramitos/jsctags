#!/usr/bin/env node

const format = require('util').format;
const forceArray = require('force-array');
const argv = require('optimist').argv;
const path = require('path');
const glob = require('glob');
const collect = require('collect-stream');
const flatten = require('lodash.flatten');
const async = require('async');
const fs = require('fs');

const jsctags = require('../');

const dir = (function () {
  if (argv.dir) {
    return path.resolve(argv.dir);
  }

  if (argv.file) {
    return path.dirname(argv.file);
  }

  if (argv._.length) {
    return path.dirname(argv._[0]);
  }

  return '///null';
})();

const file = (function () {
  if (argv.file) {
    return path.resolve(process.cwd(), argv.file);
  }

  if (!argv._.length && !argv.find) {
    return format('///null/%s', Math.floor(Math.random() * 100));
  }

  const find = forceArray(argv.find);
  const files = find.length ?
    find.reduce((files, pattern) => {
      return files.concat(
        glob.sync(pattern, {
          nosort: true,
          silent: true
        })
      );
    }, []) :
    argv._;

  return files.map(file => {
    return path.resolve(process.cwd(), file);
  });
})();

const outputTags = function (tags) {
  const ctags = flatten(jsctags.ctags(tags));
  console.log(ctags.join(''));
};

const outputJSON = function (tags) {
  console.log(JSON.stringify(flatten(forceArray(tags)), null, 2));
};

const onResults = function (err, results) {
  if (err) {
    throw err;
  }

  const fn = argv.f ? outputTags : outputJSON;

  const tags = results.filter(res => {
    if (res instanceof Error) {
      console.error(err);
      return false;
    }

    return true;
  });

  tags.tagfile = results.tagfile;

  fn(tags);
};

const parse = function (ctx, fn) {
  jsctags(ctx, (err, tags) => {
    if (err) {
      return fn(err);
    }

    tags.tagfile = ctx.file;
    tags.forEach(tag => {
      tag.tagfile = ctx.file;
    });

    fn(err, tags);
  });
};

const fromStdin = function () {
  collect(process.stdin, (err, content) => {
    if (err) {
      throw err;
    }

    if (Buffer.isBuffer(content)) {
      content = content.toString();
    }

    parse(
      {
        file,
        dir,
        content
      },
      onResults
    );
  });
};

const fromFiles = function () {
  const files = Array.isArray(file) ? file : [file];
  async.map(
    files,
    (file, fn) => {
      fs.readFile(file, 'utf8', (err, content) => {
        if (err) {
          return fn(null, err);
        }

        parse(
          {
            file,
            dir,
            content
          },
          fn
        );
      });
    },
    onResults
  );
};

(!argv._.length && !argv.find ? fromStdin : fromFiles)();
